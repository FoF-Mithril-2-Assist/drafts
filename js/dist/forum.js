module.exports=function(t){var e={};function r(a){if(e[a])return e[a].exports;var n=e[a]={i:a,l:!1,exports:{}};return t[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,a){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(a,n,function(e){return t[e]}.bind(null,n));return a},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=25)}([function(t,e){t.exports=flarum.core.compat.extend},function(t,e){t.exports=flarum.core.compat.Model},function(t,e){t.exports=flarum.core.compat["components/Button"]},function(t,e){t.exports=flarum.core.compat["components/Composer"]},function(t,e){t.exports=flarum.core.compat.app},function(t,e){t.exports=flarum.core.compat["components/DiscussionComposer"]},function(t,e){t.exports=flarum.core.compat["components/LoadingIndicator"]},function(t,e){t.exports=flarum.core.compat["components/SettingsPage"]},function(t,e){t.exports=flarum.core.compat["models/User"]},function(t,e){t.exports=flarum.core.compat["components/Alert"]},,function(t,e){t.exports=flarum.core.compat["utils/mixin"]},function(t,e){t.exports=flarum.core.compat["components/Page"]},function(t,e){t.exports=flarum.core.compat.Component},function(t,e){t.exports=flarum.core.compat["helpers/avatar"]},function(t,e){t.exports=flarum.core.compat["helpers/icon"]},function(t,e){t.exports=flarum.core.compat["helpers/humanTime"]},function(t,e){t.exports=flarum.core.compat["utils/string"]},function(t,e){t.exports=flarum.core.compat["components/Modal"]},function(t,e){t.exports=flarum.core.compat["components/HeaderSecondary"]},function(t,e){t.exports=flarum.core.compat["components/NotificationsDropdown"]},function(t,e){t.exports=flarum.core.compat["components/FieldSet"]},function(t,e){t.exports=flarum.core.compat["components/Switch"]},function(t,e){t.exports=flarum.core.compat["utils/ItemList"]},,function(t,e,r){"use strict";function a(){return(a=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(t[a]=r[a])}return t}).apply(this,arguments)}r.r(e);var n=r(0),o=r(8),s=r.n(o),i=r(1),c=r.n(i);function u(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var f=r(11),p=function(t){function e(){return t.apply(this,arguments)||this}return u(e,t),e}(r.n(f)()(c.a,{user:c.a.hasOne("user"),content:c.a.attribute("content"),title:c.a.attribute("title"),scheduledValidationError:c.a.attribute("scheduledValidationError"),relationships:c.a.attribute("relationships"),scheduledFor:c.a.attribute("scheduledFor",c.a.transformDate),updatedAt:c.a.attribute("updatedAt",c.a.transformDate)})),l=r(12),d=r.n(l),h=r(13),v=r.n(h),b=r(6),g=r.n(b),y=r(5),x=r.n(y),_=r(14),N=r.n(_),w=r(15),j=r.n(w),A=r(16),I=r.n(A),k=r(17),D=r(2),S=r.n(D),O=r(9),E=r.n(O),F=r(18),C=r.n(F),M=function(){function t(t){return function(e){return new Promise((function(r,a){var n=document.createElement(t),o="body",s="src";switch(n.onload=function(){r(e)},n.onerror=function(){a(e)},t){case"script":n.async=!0;break;case"link":n.type="text/css",n.rel="stylesheet",s="href",o="head"}n[s]=e,document[o].appendChild(n)}))}}return{css:t("link"),js:t("script"),img:t("img")}}(),B=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var r=e.prototype;return r.init=function(){t.prototype.init.call(this),this.loading=!1},r.className=function(){return"ScheduleDraftModal"},r.title=function(){return app.translator.trans("fof-drafts.forum.schedule_draft_modal.title")},r.content=function(){return this.loading?m(g.a,null):[this.props.draft.scheduledFor()?m("div",{className:"Modal-alert"},m(E.a,{type:"success",dismissible:!1},app.translator.trans("fof-drafts.forum.schedule_draft_modal.scheduled_text",{datetime:moment(this.props.draft.scheduledFor()).format("LLLL")}))):"",this.props.draft.scheduledValidationError()?m("div",{className:"Modal-alert"},m(E.a,{type:"error",dismissible:!1},app.translator.trans("fof-drafts.forum.schedule_draft_modal.scheduled_error",{error:this.props.draft.scheduledValidationError()}))):"",m("input",{style:"display: none"}),m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},app.translator.trans("fof-drafts.forum.schedule_draft_modal.text")),m("div",{className:"Form-group flatpickr"},m("input",{name:"scheduledFor",className:"FormControl flatpickr-input","data-input":!0,onchange:m.redraw})),m("div",{className:"Form-group"},S.a.component({className:"Button Button--block"+(this.unscheduleMode()?" Button--danger":" Button--primary"),type:"submit",loading:this.loading,children:this.unscheduleMode()?app.translator.trans("fof-drafts.forum.schedule_draft_modal.unschedule_button"):this.rescheduleMode()?app.translator.trans("fof-drafts.forum.schedule_draft_modal.reschedule_button"):app.translator.trans("fof-drafts.forum.schedule_draft_modal.schedule_button")}))))]},r.config=function(t){var e=this;if(!t){var r=app.forum.attribute("baseUrl")+"/assets/extensions/fof-drafts/flatpickr";this.loading=!0,Promise.all("undefined"==typeof flatpickr?[M.js(r+".js"),M.css(r+".css")]:[]).then((function(){e.loading=!1,m.redraw(),e.flatpickr=flatpickr(".flatpickr-input",{enableTime:!0,enableSeconds:!1,minDate:Date.now(),maxDate:new Date(9999,12,31),defaultDate:e.props.draft.scheduledFor()})}))}},r.scheduledFor=function(){return new Date($("input[name=scheduledFor]").val())},r.changed=function(){var t=function(t){return t?t.getTime():null};return t(this.scheduledFor())!==t(this.props.draft.scheduledFor())},r.unscheduleMode=function(){return!this.changed()&&this.props.draft.scheduledFor()},r.rescheduleMode=function(){return this.changed()&&this.props.draft.scheduledFor()},r.onsubmit=function(t){var e=this;t.preventDefault(),this.loading=!0,this.props.draft.save({scheduledFor:this.unscheduleMode()?null:this.scheduledFor(),clearValidationError:!0,scheduledValidationError:""}).then((function(){return e.success=!0})).catch((function(){})).then(this.loaded.bind(this))},e}(C.a),P=function(t,e){return Array.isArray(t)?t.map(e).sort():e(t)},L=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var r=e.prototype;return r.config=function(t){t&&$(".draft--delete").on("click tap",(function(t){t.stopPropagation()}))},r.view=function(){var t=this,e=app.store.all("drafts");return m("div",{className:"NotificationList DraftsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},app.translator.trans("fof-drafts.forum.dropdown.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},e.length?e.sort((function(t,e){return e.updatedAt()-t.updatedAt()})).map((function(e){return m("li",null,m("a",{onclick:t.showComposer.bind(t,e),className:"Notification draft--item"},N()(e.user()),j()("fas fa-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},e.title()),I()(e.updatedAt()),S.a.component({icon:"fas fa-times",style:"float: right; z-index: 20;",className:"Button Button--icon Button--link draft--delete",title:app.translator.trans("fof-drafts.forum.dropdown.delete_button"),onclick:function(r){t.deleteDraft(e),r.stopPropagation()}}),app.forum.attribute("canScheduleDrafts")&&app.forum.attribute("drafts.enableScheduledDrafts")?S.a.component({icon:e.scheduledValidationError()?"fas fa-calendar-times":e.scheduledFor()?"fas fa-calendar-check":"fas fa-calendar-plus",style:"float: right; z-index: 20;",className:"Button Button--icon Button--link draft--schedule",title:app.translator.trans("fof-drafts.forum.dropdown.schedule_button"),onclick:function(r){t.scheduleDraft(e),r.stopPropagation()}}):"",m("div",{className:"Notification-excerpt"},Object(k.truncate)(e.content(),200)),e.scheduledValidationError()?m("p",{className:"scheduledValidationError"},e.scheduledValidationError()):""))})):"",this.loading?g.a.component({className:"LoadingIndicator--block"}):!e.length&&m("div",{className:"NotificationList-empty"},app.translator.trans("fof-drafts.forum.dropdown.empty_text")))))},r.deleteDraft=function(t){var e=this;this.loading=!0,window.confirm(app.translator.trans("fof-drafts.forum.dropdown.alert"))&&t.delete().then((function(){app.composer.component&&app.composer.component.draft.id()===t.id()&&!app.composer.changed()&&app.composer.hide(),e.loading=!1}))},r.scheduleDraft=function(t){app.forum.attribute("canScheduleDrafts")&&app.forum.attribute("drafts.enableScheduledDrafts")&&app.modal.show(new B({draft:t}))},r.showComposer=function(t){if(!this.loading){var e=m.deferred(),r={originalContent:t.content(),title:t.title(),user:app.session.user,confirmExit:app.translator.trans("fof-drafts.forum.composer.exit_alert"),draft:t},a=t.relationships();a&&Object.keys(a).forEach((function(t){var e=a[t];r[t]=P(e.data,(function(t){return app.store.getById(t.type,t.id)}))}));var n=new x.a(r);return app.composer.load(n),app.composer.show(),e.resolve(n),e.promise}},r.load=function(){var t=this;app.cache.draftsLoaded||(this.loading=!0,m.redraw(),app.store.find("drafts").then((function(){return app.cache.draftsLoaded=!0}),(function(){})).then((function(){t.loading=!1,m.redraw()})))},e}(v.a),V=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var r=e.prototype;return r.init=function(){t.prototype.init.call(this),app.history.push("drafts"),this.list=new L,this.bodyClass="App--drafts"},r.view=function(){return m("div",{className:"DraftsPage"},this.list.render())},e}(d.a),T=r(4),U=r.n(T),z=r(19),R=r.n(z),G=r(20),H=function(t){function e(){return t.apply(this,arguments)||this}u(e,t),e.initProps=function(e){e.label=e.label||app.translator.trans("fof-drafts.forum.dropdown.tooltip"),e.icon=e.icon||"fas fa-edit",t.initProps.call(this,e)};var r=e.prototype;return r.init=function(){t.prototype.init.call(this),this.list=new L},r.goToRoute=function(){m.route(app.route("drafts"))},r.getUnreadCount=function(){return app.cache.draftsLoaded?app.store.all("drafts").length:app.store.all("drafts").length+app.session.user.draftCount()},r.getNewCount=function(){return this.getUnreadCount()},e}(r.n(G).a),Z=r(21),q=r.n(Z),J=r(7),K=r.n(J),Q=r(22),W=r.n(Q),X=r(23),Y=r.n(X),tt=r(3),et=r.n(tt);app.initializers.add("fof-drafts",(function(){app.store.models.drafts=p,s.a.prototype.drafts=c.a.hasMany("drafts"),s.a.prototype.draftCount=c.a.attribute("draftCount"),app.routes.drafts={path:"/drafts",component:m(V,null)},et.a.prototype.changed=function(){var t=this;if(!this.component)return!1;var e=this.component.data(),r=this.component.draft,a=Object.keys(e).filter((function(t){return"relationships"!==t}));if(!a)return!1;var n=function(r){return("content"===r?t.component.editor.value():e[r])||""},o=a,s=Array.isArray(o),i=0;for(o=s?o:o[Symbol.iterator]();;){var c;if(s){if(i>=o.length)break;c=o[i++]}else{if((i=o.next()).done)break;c=i.value}var u=c;if(r){if(n(u)!=r[u]())return!0}else if(n(u))return!0}if(!e.relationships)return!1;for(var f=function(t,e,r){if(!(t.relationships[r].length||r in e.relationships()&&e.relationships()[r].data.length))return!0;if(!(r in e.relationships())||t.relationships[r].length!==e.relationships()[r].data.length)return!1;var a=function(t){return"function"==typeof t.id?t.id():t.id},n=P(t.relationships[r],a),o=P(e.relationships()[r].data,a);return!n.some((function(t,e){return t!==o[e]}))},p=0,l=Object.keys(e.relationships);p<l.length;p++){var d=l[p];if(r){if(!f(e,r,d))return!0}else if(e.relationships[d])return!0}return!1},et.a.prototype.saveDraft=function(){var t=this;this.saving=!0,m.redraw();var e=function(){t.saving=!1,t.justSaved=!0,setTimeout((function(){t.justSaved=!1,m.redraw()}),300),m.redraw()};this.component.draft?(delete this.component.draft.data.attributes.relationships,this.component.draft.save(a(this.component.draft.data.attributes,this.component.data())).then((function(){return e()}))):app.store.createRecord("drafts").save(this.component.data()).then((function(r){t.component.draft=r,e()}))},Object(n.extend)(et.a.prototype,"controlItems",(function(t){if(this.component instanceof x.a&&app.forum.attribute("canSaveDrafts")&&this.position!==et.a.PositionEnum.MINIMIZED){var e=["Button","Button--icon","Button--link"];this.saving&&e.push("saving"),this.justSaved&&e.push("justSaved"),t.add("save-draft",S.a.component({icon:this.justSaved?"fas fa-check":this.saving?"fas fa-spinner fa-spin":"fas fa-save",className:e.join(" "),itemClassName:"App-backControl",title:app.translator.trans("fof-drafts.forum.composer.title"),disabled:this.saving||this.justSaved,onclick:this.saveDraft.bind(this)}),20)}})),Object(n.extend)(et.a.prototype,"init",(function(){var t=this;app.forum.attribute("canSaveDrafts")&&app.session.user.preferences().draftAutosaveEnable&&(this.autosaveInterval=setInterval((function(){t.changed()&&!t.saving&&t.saveDraft()}),1e3*app.session.user.preferences().draftAutosaveInterval))})),Object(n.extend)(et.a.prototype,"close",(function(){this.autosaveInterval&&clearInterval(this.autosaveInterval)})),Object(n.override)(et.a.prototype,"preventExit",(function(t){this.component&&this.component.draft&&(this.component.props.confirmExit=app.translator.trans("fof-drafts.forum.composer.exit_alert"));var e=!1;if(this.changed()&&(e=t()),e)return e;if(this.component){var r=this.component.draft;return r&&!r.title()&&!r.content()&&confirm(app.translator.trans("fof-drafts.forum.composer.discard_empty_draft_alert"))&&r.delete(),e}})),Object(n.extend)(x.a.prototype,"init",(function(){var t=this;Object.keys(this.props).forEach((function(e){["originalContent","title","user"].includes(e)?"title"===e&&(t.title=m.prop(t.props.title)):t[e]=t.props[e]}))})),Object(n.extend)(x.a.prototype,"onsubmit",(function(){this.draft&&this.draft.delete()})),Object(n.extend)(R.a.prototype,"items",(function(t){U.a.session.user&&U.a.forum.attribute("canSaveDrafts")&&t.add("Drafts",m(H,null),20)})),Object(n.extend)(K.a.prototype,"init",(function(){this.draftAutosaveInterval=m.prop(this.user.preferences().draftAutosaveInterval)})),Object(n.extend)(K.a.prototype,"settingsItems",(function(t){t.add("drafts",q.a.component({label:app.translator.trans("fof-drafts.forum.user.settings.drafts_heading"),className:"Settings-drafts",children:this.draftsItems().toArray()}))})),K.a.prototype.draftsItems=function(){var t=this,e=new Y.a;return e.add("draft-autosave-enable",W.a.component({children:app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_enable"),state:this.user.preferences().draftAutosaveEnable,onchange:function(e,r){return t.preferenceSaver("draftAutosaveEnable")(e,r)}})),e.add("draft-autosave-interval",this.user.preferences().draftAutosaveEnable?m("label",null,m("p",null,app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_interval_label")),m("input",{className:"FormControl",type:"number",min:"0",value:this.draftAutosaveInterval(),onchange:m.withAttr("value",this.draftAutosaveInterval)}),S.a.component({className:"Button Button--primary",children:app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_interval_button"),onclick:function(){var e;t.draftAutosaveInterval()<0||(e=t.draftAutosaveInterval())!=Math.round(e)?(t.draftAutosaveIntervalInvalid=!0,t.draftAutosaveInterval(t.user.preferences().draftAutosaveInterval),m.redraw()):(t.draftAutosaveIntervalInvalid=!1,t.preferenceSaver("draftAutosaveInterval")(t.draftAutosaveInterval()))}}),this.draftAutosaveIntervalInvalid?m("p",{class:"invalidInterval"},m("small",null,app.translator.trans("fof-drafts.forum.user.settings.draft_autosave_interval_invalid"))):""):""),e}}))}]);
//# sourceMappingURL=forum.js.map